/*
 ************************
 * general object funcs *
 ************************
 */

function getID (range)
{
	var row = range.getRow();
	var tab = range.getSheet();
	var last_header_row = tab.getFrozenRows();
	if (row <= last_header_row)
	{
		l.showError("Get out of the header!");
		return;
	}

	var id_col = l.getColumnOfHeader(tab, "ID");
	if (id_col == undefined)
	{
		l.showError("You're not on a sheet with an ID column.");
		return;
	}
	var vals = tab.getSheetValues(row, id_col, 1, 1);
	Logger.log("getID: returning ID " + vals[0][0]);
	return vals[0][0];
}

function getRowForObject (id)
{
	var me = SpreadsheetApp.getActiveSpreadsheet();
	var tab = me.getSheetByName("RawData");
	// cheating a bit by assuming ID is always in column 1 (and no frozen cols)
	// but this is also a performance enhancement, so I'll allow it
	var ids = l.getDataSlice(tab, { col: 1, as: "values" });
	for (var i=0, len=ids.length; i < len; ++i)
	{
		if (ids[i][0] == id)
		{
			// go from 0-origin to 1-origin
			// and account for header rows, which getDataColumn() throws away
			return l.getDataSlice(tab, { row: i + 1, after_headers: true, as: "range" });
		}
	}
	return;											// undefined if not found
}

function getObject (id)
{
	var values = getRowForObject(id).getValues()[0];
	var obj = {};
	for (var i=0, len=values.length; i < len; ++i)
	{
		Logger.log("getObject: calling dataHeaderColumn(" + (i + 1) + ")");
		var header = dataHeaderColumn(i + 1);
		if (header == undefined)
		{
			return;
		}
		obj[header] = values[i];
	}
	return obj;
}

var data_headers;
var data_header_row;
function dataHeaderColumn (column)
{
	if (data_headers == undefined)
	{
		var tab = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("RawData");
		data_header_row = l.tabHeaders(tab);
		data_headers = {};
		for (var i=0, len=data_header_row.length; i < len; ++i)
		{
			var header = data_header_row[i].toLowerCase();
			data_header_row[i] = header;			// save LC version back to the array
			data_headers[header] = i + 1;			// go from 0-origin to 1-origin
		}
	}

	if (typeof(column) == 'number' && column > 0 && column <= data_header_row.length)
	{
		return data_header_row[column - 1];
	}
	else if (typeof(column) == 'string' && data_headers.hasOwnProperty(column))
	{
		return data_headers[column];
	}
	else
	{
		l.showError("No such column in data: " + column);
		return;
	}
}

function dataSet (row, column, value)
{
	if (!typeof(row) == "Range")
	{
		l.showError("dataSet: first arg must be a Range");
		return;
	}

	var col = dataHeaderColumn(column);
	if (col == undefined)
	{
		return;
	}
	else
	{
		row.getCell(1, col).setValue(value);
		return 1;
	}
}

function newItem (object)
{
	var tab = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("RawData");
	var headers = l.tabHeaders(tab);
	var new_row = l.getFirstEmptyRow("RawData", 10);
	if (new_row == undefined)
	{
		l.showError("can't find an empty row for a new item");
		return;
	}
	if (!object.hasOwnProperty("description"))
	{
		l.showError("can't make an item without a description");
		return;
	}

	l.keys(object).forEach(function (key)
	{
		Logger.log("newItem: going to set " + key + " to " + object[key]);
		if (dataSet(new_row, key, object[key]) == undefined)
		{
			return;
		}
	});

	return new_row;
}

function updateItem (object)
{
	if (!object.hasOwnProperty("id"))
	{
		l.showError("Can't update item without ID.");
		return;
	}

	var row = getRowForObject(object.id);
	if (row == undefined)
	{
		l.showError("Illegal ID " + id + " (which should be impossible).");
		return;
	}

	for (var key in object)
	{
		// see above
		if (key != "id" && object.hasOwnProperty(key))
		{
			if (dataSet(row, key, object[key]) == undefined)
			{
				// error should have been shown by dataSet()
				return;
			}
		}
	}
}

function splitItem ()
{
	var id = getIDofCurrentRow();
	if (id == undefined)
	{
		return;
	}

	var obj = getObject(id);
	Logger.log("splitItem: object with keys: " + l.keys(obj).join());
	// Figure out if this item needs to be closed out.  Obviously we have to do
	// this _before_ we blank out the completed date for the new copy.
	// If it already has a completed date, don't close it out.
	var close_out = obj.completed ? false : true;
	// We'll use this object (which is just a copy of the values) to create a
	// new object, with *most* of the same values.
	delete obj.id;				// new object has to get its own ID
	delete obj.pri;				// pri is the calculated priority, so don't overwrite
	delete obj.completed;		// this may be blank already, but certainly _should_ be
	obj.added = l.today();		// we're adding it right now
	var row = newItem(obj);
	if (row == undefined)
	{
		return;
	}
	// close out the existing object if necessary
	if (close_out)
	{
		updateItem({ id: id, completed: l.today() });
	}
	// finally, let the user edit the new item if they want to
	row.activate();
}

function jumpToItem ()
{
	var id = getIDofCurrentRow();
	if (id == undefined)
	{
		return;
	}

	var row = getRowForObject(id);
	if (row == undefined)
	{
		return;
	}

	row.activate();
}


function getIDofCurrentRow ()
{
	var pos = SpreadsheetApp.getActiveSpreadsheet().getActiveCell();
	var id = getID(pos);
	if (id == undefined)
	{
		l.showError("This row does not appear to be an item.");
		return;
	}
	return id;
}

function getCurrentRow ()
{
	var id = getIDofCurrentRow();
	if (id == undefined)
	{
		return;
	}
	return getRowForObject(id);
}

function markCompleted ()
{
	var id = getIDofCurrentRow();
	if (id == undefined)
	{
		return;
	}

	updateItem({ id: id, completed: l.today() });
}

function markCancelled ()
{
	var id = getIDofCurrentRow();
	if (id == undefined)
	{
		return;
	}
	var reason = l.prompt("CANCEL ITEM", "Reason for cancellation:");
	if (reason == undefined)
	{
		return;
	}

	var obj = getObject(id);
	var descr = obj.description + ' {' + reason + '}';
	updateItem({ id: id, list: 'Cancelled', completed: l.today(), description: descr });
}

function setDueDate (new_val)
{
	var item = getCurrentRow();
	if (item == undefined)
	{
		return;
	}

	var due_col = dataHeaderColumn("due");
	var cell = item.getCell(1, due_col);
	if ( typeof(new_val) == "Date" )
	{
		l.dateIntoCell(new_val, cell);
	}
	else
	{
		cell.setValue( new_val );
	}
}

function tweakPriority (amount)
{
	var item = getCurrentRow();
	if (item == undefined)
	{
		return;
	}

	var due_col = dataHeaderColumn("due");
	var cell = item.getCell(1, due_col);
	var value = cell.getValue();
	if (value != "")
	{
		var date = l.dateFromCell(cell);
		Logger.log("tweakPriority: got date from cell: " + date.toString());
		date.setDate(date.getDate() + amount);
		l.dateIntoCell(date, cell);
	}
	else
	{
		var pri_col = dataHeaderColumn("priority");
		cell = item.getCell(1, pri_col);
		value = cell.getValue();
		if (value != "")
		{
			var letter = value.charCodeAt(0) - 64;	// so "A" == 1, "B == 2, "C" == 3
			var number = value.charAt(1);
			number = Number(number) + amount;
			if (number < 1 || number > 3)
			{
				// subtract 1 to go back to 0-index
				number -= 1;
				// divide by 3 because this is essentially base-3
				// then floor (not truncate!) to get the proper integer
				var letter_adjustment = Math.floor( number / 3 );
				letter += letter_adjustment;
				// number is now the remainder
				// see: http://javascript.about.com/od/problemsolving/a/modulobug.htm
				// have I mentioned lately that Javascript is stupid?
				number = (number % 3 + 3) % 3;
				// and, finally, back to 1-index
				number += 1;
				if (letter < 1 || letter > 3)
				{
					l.showError("trying to adjust priority out-of-bounds: " + letter + '/' + number);
					return;
				}
			}
			var new_pri = String.fromCharCode(64 + letter) + number;
			Logger.log("tweakPriority: setting (hopefully) to new priority: " + new_pri);
			cell.setValue(new_pri);
		}
		else
		{
			if (l.confirm("No priority or due date; shall we push from today's date?"))
			{
				var date = new Date( Date.parse(l.today()) );
				date.setDate(date.getDate() + amount);
				cell = item.getCell(1, due_col);
				l.dateIntoCell(date, cell);
			}
			else
			{
				l.showError("Don't know how to push/bump (item has no due date or priority).");
				return;
			}
		}
	}
}

function bumpItem () { tweakPriority(-1) }
function pushItem () { tweakPriority(1)  }

function pushItemArbitrary ()
{
	var push_amt = l.prompt("PUSH ITEM", "Push by (days) or push to (date):");
	if (push_amt == undefined)
	{
		return;
	}

	// check to see whether it's a date or an offset
	push_amt = push_amt.toLowerCase();
	if ( new RegExp('/').test(push_amt) )			// prolly nicer-looking than `/\//.test` ...
	{
		setDueDate(push_amt);
	}
	else if ( /^[+-]?\d+$/.test(push_amt) )
	{
		tweakPriority(Number(push_amt));
	}
	else if ( /^[a-z]+$/.test(push_amt) )
	{
		var days = { sun: 0, mon: 1, tue: 2, wed: 3, thu: 4, fri: 5, sat: 6 };
		var day = days[push_amt];
		if (day == undefined)
		{
			l.showError("I thought " + push_amt + " was a day name, but I don't recognize it.");
			return;
		}

		var date = new Date( Date.parse(l.today()) );
		Logger.log("pushItemArbitrary: getDay => " + date.getDay() + " offset => " + ((day + 7 - date.getDay()) % 7));
		date.setDate( date.getDate() + ((day + 7 - date.getDay()) % 7) );
		Logger.log("pushItemArbitrary: new date => " + date.toISOString());
		setDueDate(date);
	}
	else
	{
		l.showError("Don't know how to convert " + push_amt + " to a date or date offset.");
		return;
	}
}


/*
 ********************
 *		InTray		*
 ********************
 */

function newInTray ()
{
	var descr = l.prompt("NEW ITEM", "Item to add to in tray:");
	if (descr == undefined)
	{
		return;
	}
	newItem({ list: "InTray", added: l.today(), description: descr });
}

function newAndEdit ()
{
	var descr = l.prompt("NEW ITEM", "Item to add:");
	if (descr == undefined)
	{
		return;
	}
	var row = newItem({ list: "InTray", added: l.today(), description: descr });
	row.activate();
}

function emptyInTray ()
{
	var tab = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("InTray");
	var first_row = tab.getFrozenRows() + 1;
	var last_row = l.getFirstEmptyRow("InTray", 11).getRow() - 1;
	if (first_row > last_row)
	{
		l.showError("InTray is already empty!");
		return;
	}

	Logger.log("emptyInTray: going from row " + last_row + " to row " + first_row);
	for (var i=last_row; i >= first_row; --i)
	{
		var row = l.getDataSlice(tab, { row: i, as: 'range' });
		var new_list = row.getValue();				// value of the first cell in the row
		var id = getID(row);
		updateItem({ id: id, list: new_list });
		row.getCell(1, 1).clear();					// clear out the new_list value now that we've used it
	}
}


/*
 ********************
 *		Tasks		*
 ********************
 */

function newTaskToday (mark_completed)
{
	// Handle defaults, since GAS JS is too old to do it in the signature.
	if ( mark_completed == undefined )
	{
		mark_completed = false;
	}

	var descr = l.prompt("NEW TASK", "Task to add:");
	if (descr == undefined)
	{
		return;
	}
	var context = l.prompt("NEW TASK", "Context (required):");
	if (context == undefined)
	{
		return;
	}
	var code = l.prompt("NEW TASK", "Code (optional):");
	if (code == undefined)
	{
		code = '';
	}
	var obj = { list: "Task", context: context, added: l.today(), code: code, description: descr };
	if (mark_completed)
	{
		obj.completed = l.today();
	}
	else
	{
		obj.due = l.today();
	}
	newItem(obj);
}

function newTaskCompleted () { newTaskToday(true) }


function newTask ()
{
	l.showError("This function doesn't work any more.");
	return;

	var taskname = l.prompt("NEW TASK", "Name of task:");
	if (taskname == undefined)
	{
		return;
	}
	var priority = l.prompt("NEW TASK", "Priority for new task:");
	if (priority == undefined)
	{
		return;
	}

	var tab = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Tasks");
	var data = tab.activate().getDataRange().getValues();
	for (var i=0; i < data.length; ++i)
	{
		if (data[i][0] == "")
		{
			Logger.log("newTask: found blank row " + row);
			tab.getRange(i + 1, 1).setValues([priority, taskname]);
			resort();
			return;
		}
	}
	/* no blank row found; make one */
	tab.appendRow([priority, taskname]);
	resort();
}


/*
 ********************
 *		Daily		*
 ********************
 */

function newDay ()
{
	Logger.log("newDay: firing up");
	var me = SpreadsheetApp.getActiveSpreadsheet();
	var tab = me.getSheetByName("Today");
	tab.activate();
	Logger.log("newDay: activated tab");

	// save any potential changes to "yesterday"
	// before we switch over to "tomorrow"
	saveDay();

	var date = me.getRange("TodaysDate");
	date.setValue( l.today() );

	Logger.log("newDay: going to pull template tab");
	var templ = me.getSheetByName("DayTemplates");
	Logger.log("newDay: going to find 'Today' header");
	var col = l.getColumnOfHeader(templ, "Today");
	Logger.log("newDay: pulling new schedule");
	var values = l.getDataSlice(templ, { col: col, as: 'values' });
	var schedule = l.getDataSlice(tab, { col: l.getColumnOfHeader(tab, "Schedule"), as: 'range' });
	Logger.log("newDay: finding old schedule");
	Logger.log("newDay: going to get value at " + templ.getRange(2, 2).getA1Notation());
	var start_time = templ.getRange(2, 2).getValue();
	// cut schedule down to however many values we got back from the template
	schedule = schedule.offset(0, 0, values.length);
	schedule.setValues(values);
	tab.getRange(1, 2).setValue(start_time);

	// now that "tomorrow" is "today," save again
	saveDay();
}


function saveDay ()
{
	Logger.log("saveDay: firing up");
	var me = SpreadsheetApp.getActiveSpreadsheet();
	var tab = me.getSheetByName("Today");
	tab.activate();
	var date = me.getRange("TodaysDateSortable").getValue();

	// using hardcoded ID for diary sheet open
	// less than ideal, but a PITA to do it any other way
	Logger.log("saveDay: about to open diary");
	var diary = SpreadsheetApp.openById("1F9ge-m3ez4Yp4jzuQvtRolTP61Dr1rH7D2qoibRxkzI");
	var day = diary.getSheetByName(date);
	Logger.log("saveDay: trying to find sheet: " + date);
	if (day == null)
	{
		// fresh copy
		Logger.log("saveDay: fresh copy");
		var day = tab.copyTo(diary);
		Logger.log("saveDay: created new sheet");
		day.setName(date);

		var due_values = l.getDataBlock(tab, "#2", "#3").getValues();
		l.getDataBlock(day, "#2", "#3").setValues(due_values);

		// tweak column headers
		var top_row = tab.getSheetValues(1, 1, 1, tab.getMaxColumns())[0];
		for (var i=0, len=top_row.length; i < len; ++i)
		{
			Logger.log("saveDay: at column " + (i + 1) + ", top row is " + top_row[i]);
			if (top_row[i] == "Todo Today")
			{
				Logger.log("saveDay: resetting column header at 1," + (i + 1));
				day.getRange(1, i + 1).setValue("At Start: " + top_row[i]);
			}
			else if (top_row[i] == "Completed Today")
			{
				Logger.log("saveDay: resetting column header at 1," + (i + 1));
				day.getRange(1, i + 1).setValue("At End: " + top_row[i]);
			}
		}
	}
	else
	{
		// recopy start/end hour and schedule data
		Logger.log("saveDay: recopy left and right panes");
		day.getRange("TodaysStartHour").setValue(tab.getRange("TodaysStartHour").getValue());
		day.getRange("TodaysEndHour").setValue(tab.getRange("TodaysEndHour").getValue());
		var schedule = l.getDataBlock(tab, "Schedule", "Schedule").getValues();
		l.getDataBlock(day, "Schedule", "Schedule").setValues(schedule);

		// copy completed tasks
		var completed = l.getDataBlock(tab, "#3", "#END").getValues();
		l.getDataBlock(day, "#3", "#END").setValues(completed);
	}
}


function saveToHistory ()
{
	Logger.log("saveToHistory: firing up");
	var diary = SpreadsheetApp.openById("1F9ge-m3ez4Yp4jzuQvtRolTP61Dr1rH7D2qoibRxkzI");
	l.progress("Finding earliest month");
	var tabs = diary.getSheets();

	var quarters   = new Object();
	var month_tabs = new Object();
	for (var i = 0; i < tabs.length; ++i)
	{
		var name = tabs[i].getName();
		if ( /\d\d\d\d-\d\d-\d\d/.test(name) )
		{
			var year  = name.substr(0,4);
			var month = name.substr(5,2);
			var quarter = l.int((month - 1) / 3) + 1;
			var sheet_name = "CalenDiary History " + year + "-Q" + quarter;
			if (month_tabs[month] == undefined)
			{
				month_tabs[month] = [];
			}
			month_tabs[month].push(tabs[i]);
			if (quarters[sheet_name] == undefined || month < quarters[sheet_name])
			{
				quarters[sheet_name] = month;
			}
		}
	}
	l.progress("Finding history sheet name");
	var potentials = l.keys(quarters);
	potentials.sort();
	var history_name = potentials[0];
	var history_files = DriveApp.getFilesByName(history_name);
	if (history_files.hasNext())
	{
		var history = SpreadsheetApp.open(history_files.next());
		var tabs_to_save = month_tabs[quarters[history_name]];
		var tab_names = tabs_to_save.map(function (_) { return _.getName() }).toString();
		if (l.confirm("Will save these tabs to " + history_name + ": " + tab_names))
		{
			for (var i = 0; i < tabs_to_save.length; ++i)
			{
				var day = tabs_to_save[i];
				var day_name = day.getName();
				l.progress("Moving tab: " + day_name);
				var new_tab = day.copyTo(history);
				new_tab.setName(day_name);
				diary.deleteSheet(day);
			}
		}
		else
		{
			l.showError("Bailing out at user request.");
		}
	}
	else
	{
		l.showError("You must create sheet: " + history_name);
	}
	l.progress("Done");
}


/*
 ********************
 *		Projects	*
 ********************
 */


/*
 ************************
 *		multiple tabs	*
 ************************
 */

function resort ()
{
	var tab = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
	var data = tab.getDataRange().getValues();
	var to_delete = [];
	for (var i = data.length - 1; i >= 0; --i)
	{
		if (data[i][0] == "X")
		{
			var row = i + 1;
			Logger.log("resort: going to delete row " + row);
			to_delete.push(row);
		}
	}
	for (var i = 0; i < to_delete.length; ++i)
	{
		var row = to_delete[i];
		Logger.log("resort: about to delete row " + row);
		tab.deleteRow(row);
	}
	tab.sort(1);
	tab.getRange(tab.getFrozenRows()+1, tab.getFrozenColumns()+1).activate();
}


function jumpToBottom ()
{
	var me = SpreadsheetApp.getActiveSpreadsheet();
	var tab = me.getActiveSheet();
	var tabname = tab.getName();

	var row;
	if (tabname == "RawData")
	{
		row = l.getFirstEmptyRow(tabname, 10);
	}
	else
	{
		row = l.getFirstEmptyRow(tabname);
	}
	if (row == undefined)
	{
		l.showError("No blank rows!");
		return;
	}
	row.activate();
}


/*
 ************************
 *		sheet setup		*
 ************************
 */

function onOpen ()
{
	var ui = SpreadsheetApp.getUi();
	ui.createMenu("Todo")
		.addItem("New Item", "newInTray")
		.addItem("New Item and Jump to Edit", "newAndEdit")
		.addSubMenu(ui.createMenu("More New Stuff")
				.addItem("New Task for Today", "newTaskToday")
				.addItem("Record Completed Task", "newTaskCompleted")
				.addItem("Copy Completed Item", "splitItem")
				.addItem("New Task [old/non-working]", "newTask")
			)
		.addSeparator()
		.addItem("Jump to Full Edit", "jumpToItem")
		.addItem("Push Item (1 Day)", "pushItem")
		.addItem("Mark Completed", "markCompleted")
		.addSubMenu(ui.createMenu("More Edits")
				.addItem("Bump Item", "bumpItem")
				.addItem("Push Item (Any Amount)", "pushItemArbitrary")
				.addSeparator()
				.addItem("Split Open Item", "splitItem")
				.addItem("Cancel Item", "markCancelled")
			)
		.addSeparator()
		.addItem("Empty InTray", "emptyInTray")
		.addItem("Start a New Day", "newDay")
		.addSubMenu(ui.createMenu("More Transitions")
				.addItem("(Re)Save Day to Diary", "saveDay")
				.addItem("Save CalenDiary's Earliest Month to History", "saveToHistory")
			)
		.addSeparator()
		.addItem("Resort",   "resort")
		.addItem("Find Blank Row", "jumpToBottom")
		.addSeparator()
		.addItem("Test", "testCurrentThing")
		.addToUi();
}

function testCurrentThing ()
{
}
